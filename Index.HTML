<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    <title>ì—¬í–‰ ì¼ì • ê´€ë¦¬ (Mobile Optimized)</title>
    <style>
        /* === ê¸°ë³¸ ì„¤ì • === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #F7FCFF;
            --bg-secondary: #ffffff;
            --bg-expanded: #f8fafc;
            --text-primary: #000000;
            --text-secondary: #4b5563;
            --border: #e2e8f0;
            
            /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ (White & Sharp) */
            --btn-bg: #ffffff;
            --btn-text: #000000;
            --btn-border: #000000;
            --btn-radius: 2px;
            
            --accent: #3b82f6;
            --dining-color: #f97316;
            --ai-color: #8b5cf6;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-expanded: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #334155;
            --btn-bg: #1e293b;
            --btn-text: #ffffff;
            --btn-border: #475569;
            --accent: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        
        /* === í—¤ë” === */
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; padding: 16px; }
        .header-content { max-width: 1024px; margin: 0 auto; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; } /* align-items: centerë¡œ ë³€ê²½í•˜ì—¬ ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
        
        .trip-info { flex: 1; min-width: 0; /* í…ìŠ¤íŠ¸ ë„˜ì¹¨ ë°©ì§€ */ }
        .trip-name { font-size: 24px; font-weight: 800; margin-bottom: 4px; letter-spacing: -0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .trip-meta-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin-top: 8px; }
        .trip-details { font-size: 14px; color: var(--text-secondary); display: flex; flex-direction: column; gap: 2px; }
        
        /* D-Day ë°°ì§€ (ëª¨ë°”ì¼ ìµœì í™” ì ìš©) */
        .dday-badge { 
            font-size: 20px; 
            font-weight: 800; 
            color: var(--text-primary); 
            border: 2px solid var(--text-primary); 
            padding: 4px 12px; 
            border-radius: var(--btn-radius);
            
            /* [ìˆ˜ì •ë¨] ì¤„ë°”ê¿ˆ ë°©ì§€ ë° í¬ê¸° ê³ ì • */
            white-space: nowrap;
            flex-shrink: 0;
            margin-left: 8px;
        }

        /* === ğŸ•’ ìŠ¤ë§ˆíŠ¸ ì‹œê³„ === */
        .clock-container { display: flex; gap: 6px; }
        .clock-box {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 4px 8px; border-radius: var(--btn-radius); border: 1px solid var(--border);
            min-width: 68px; transition: all 0.3s;
        }
        .clock-box.day { background: #ffffff; color: #334155; }
        .clock-box.night { background: #1e293b; color: #ffffff; border-color: #334155; }
        .clock-label { font-size: 10px; font-weight: 700; text-transform: uppercase; opacity: 0.7; }
        .clock-time { font-size: 15px; font-weight: 700; font-variant-numeric: tabular-nums; }
        
        /* === íƒ­ ìŠ¤íƒ€ì¼ === */
        .trip-tabs { display: flex; gap: 6px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: none; }
        .trip-tab { 
            padding: 8px 12px; 
            border-radius: var(--btn-radius); 
            border: 1px solid #d1d5db; 
            background: var(--btn-bg); 
            color: var(--text-secondary); 
            white-space: nowrap; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; 
        }
        .trip-tab.active { 
            border: 2px solid var(--text-primary); 
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 800;
        }

        /* === ë²„íŠ¼ ìŠ¤íƒ€ì¼ === */
        .action-buttons { display: flex; gap: 8px; overflow-x: auto; padding: 4px 0; scrollbar-width: none; align-items: center; }
        
        .btn { 
            padding: 8px 12px; 
            border-radius: var(--btn-radius); 
            font-size: 13px; font-weight: 600; cursor: pointer; 
            border: 1px solid var(--btn-border); 
            background: var(--btn-bg); 
            color: var(--btn-text);
            white-space: nowrap; display: flex; align-items: center; gap: 6px;
            transition: all 0.2s; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            height: 36px;
        }
        .btn:active { transform: scale(0.98); background: #f1f5f9; }

        /* ì¼ì • ì¶”ê°€ ë²„íŠ¼ ê°•ì¡° */
        .btn-add-event { 
            border: 2px solid var(--text-primary) !important; 
            font-weight: 800;
        }

        /* ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½ í…ìŠ¤íŠ¸ ë¡œê³  */
        .btn-mrt {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: #2b96ed !important; 
            border-color: #2b96ed !important;
            font-weight: 700;
        }
        .mrt-my {
            font-family: 'Brush Script MT', 'Comic Sans MS', cursive;
            font-size: 1.4em;
            margin-right: 2px;
            font-style: italic;
        }
        .mrt-trip {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        /* ì»¨í…Œì´ë„ˆ & ì¹´ë“œ */
        .container { max-width: 1024px; margin: 0 auto; padding: 16px; }
        
        .day-card { 
            background: var(--bg-secondary); 
            border-radius: 8px; 
            margin-bottom: 16px; overflow: hidden; 
            border: 1px solid var(--border); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        .day-header { padding: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: var(--bg-secondary); }
        .day-card.expanded > .day-header { background: #f1f5f9; border-bottom: 1px solid var(--border); }
        
        .day-number { font-size: 18px; font-weight: 800; color: var(--text-primary); width: 32px; height: 32px; border: 2px solid var(--text-primary); border-radius: 6px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .day-text h3 { font-size: 16px; font-weight: 700; margin: 0; }
        .day-text span { font-size: 12px; color: var(--text-secondary); }
        
        .day-controls { display: flex; align-items: center; gap: 12px; }
        .btn-dining-mini { 
            background: white; color: #f97316; border: 1px solid #fed7aa; 
            padding: 4px 10px; border-radius: var(--btn-radius); 
            font-size: 12px; font-weight: 700; cursor: pointer; 
        }

        .event-list { padding: 0; background: var(--bg-expanded); display: none; }
        .day-card.expanded .event-list { display: block; padding: 16px; }

        /* ì¼ì • ì•„ì´í…œ */
        .event-item { background: white; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 10px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .category-badge { padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; color: white; display: inline-block; margin-bottom: 6px; }
        .category-í•­ê³µ { background: #3b82f6; } .category-ì¡°ì‹ { background: #f59e0b; } .category-ì ì‹¬ { background: #f97316; } .category-ì €ë… { background: #ef4444; } .category-ê´€ê´‘ { background: #10b981; } .category-íˆ¬ì–´ { background: #8b5cf6; } .category-ì‡¼í•‘ { background: #ec4899; } .category-ê¸°íƒ€ { background: #64748b; }
        
        .event-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .event-time { font-size: 13px; font-weight: 600; color: var(--accent); margin-left: 6px; }
        .event-loc { font-size: 12px; color: var(--text-secondary); display: flex; gap: 4px; margin-bottom: 6px; }
        .event-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5; white-space: pre-line; }
        .event-actions { display: flex; gap: 6px; margin-top: 12px; border-top: 1px solid #f1f5f9; padding-top: 12px; }
        .btn-sm { padding: 6px 10px; border-radius: 4px; font-size: 12px; border: 1px solid var(--border); background: white; color: var(--text-primary); cursor: pointer; }
        .btn-sm:hover { background: #f8fafc; }

        /* í•­ê³µê¶Œ ì „ìš© ìŠ¤íƒ€ì¼ */
        .flight-card { background: white; border-radius: 6px; border: 1px solid var(--border); margin-bottom: 10px; padding: 16px; border-left: 4px solid #3b82f6; }
        .flight-header { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 12px; color: #64748b; font-weight: 700; }
        .flight-route { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .port-code { font-size: 24px; font-weight: 800; color: var(--text-primary); }
        .flight-icon { font-size: 24px; color: var(--text-secondary); }
        .flight-info { font-size: 13px; color: var(--text-secondary); background: #f8fafc; padding: 8px; border-radius: 4px; }

        /* ëª¨ë‹¬ & ë“œë¡œì–´ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal.show { display: flex; }
        .modal-content { background: white; width: 90%; max-width: 400px; padding: 24px; border-radius: 8px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .form-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; font-size: 14px; }
        .form-select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; font-size: 14px; background: white; }
        .form-textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; font-size: 14px; resize: vertical; min-height: 100px; }
        .modal-header { font-size: 18px; font-weight: 800; margin-bottom: 16px; }
        .form-label { font-size: 12px; font-weight: 700; margin-bottom: 4px; display: block; color: var(--text-secondary); }
        .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        
        .photo-viewer { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .photo-viewer.show { display: flex; }
        .photo-viewer img { max-width: 100%; max-height: 100%; border-radius: 12px; }
        .empty-state { text-align: center; padding: 40px; color: var(--text-secondary); }
        
        .theme-toggle { position: fixed; bottom: 24px; right: 24px; width: 48px; height: 48px; border-radius: 50%; background: white; border: 1px solid var(--border); font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1001; display: flex; align-items: center; justify-content: center; }

        /* ë“œë¡œì–´ (ë§›ì§‘) */
        .dining-drawer { position: fixed; top: 0; right: -100%; width: 85%; max-width: 400px; height: 100%; background: white; z-index: 3000; transition: right 0.3s; box-shadow: -5px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .dining-drawer.open { right: 0; }
        .drawer-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .drawer-content { padding: 16px; overflow-y: auto; flex: 1; }
        .restaurant-item { border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 10px; }
        .res-name { font-size: 16px; font-weight: 700; color: var(--text-primary); display: block; margin-bottom: 2px;}
        .res-desc { font-size: 12px; color: var(--text-secondary); display: block; line-height: 1.3; }
        .res-details { background: #f8fafc; padding: 8px; border-radius: 8px; margin-top: 6px; margin-bottom: 6px; border: 1px solid #f1f5f9; }
        .res-row { display: flex; align-items: flex-start; gap: 4px; margin-bottom: 4px; font-size: 11px; line-height: 1.3; }
        .res-row:last-child { margin-bottom: 0; }
        .res-icon { flex-shrink: 0; width: 14px; text-align: center; }
        .res-text { color: var(--text-secondary); }
        .res-label { font-weight: 700; color: var(--dining-color); margin-right: 2px; }
        .btn-map-sm { font-size: 11px; padding: 3px 8px; background: #e0f2fe; color: #0284c7; border-radius: 6px; text-decoration: none; font-weight: 600; }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2999; display: none; }
        .drawer-overlay.show { display: block; }

        /* ì±—ë´‡ ìŠ¤íƒ€ì¼ */
        .chat-container { height: 300px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 10px; background: #f8fafc; border-radius: 6px; margin-bottom: 10px; border: 1px solid var(--border); }
        .chat-msg { padding: 8px 12px; border-radius: 6px; margin-bottom: 8px; font-size: 13px; max-width: 85%; }
        .chat-msg.user { background: #3b82f6; color: white; margin-left: auto; }
        .chat-msg.ai { background: white; border: 1px solid var(--border); margin-right: auto; }
        .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }
        
        /* ëª¨ë°”ì¼ ìµœì í™” ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (max-width: 480px) {
            .trip-name { font-size: 20px; }
            .dday-badge { font-size: 16px; padding: 4px 8px; }
            .clock-box { padding: 2px 6px; min-width: 60px; }
            .clock-time { font-size: 13px; }
        }
    </style>
</head>
<body>

<div id="app"></div>
<div id="modal-container"></div>

<!-- ë§›ì§‘ ë“œë¡œì–´ -->
<div class="drawer-overlay" onclick="app.closeDiningDrawer()"></div>
<div id="diningDrawer" class="dining-drawer">
    <div class="drawer-header">
        <h3 style="margin:0; font-size:16px;">ğŸ½ï¸ ë§›ì§‘ ê°€ì´ë“œ</h3>
        <button class="btn" onclick="app.closeDiningDrawer()" style="border:none; background:none; font-size:20px;">âœ•</button>
    </div>
    <div id="diningContent" class="drawer-content"></div>
</div>

<button class="theme-toggle" onclick="app.toggleTheme()" id="themeToggle">ğŸŒ™</button>
<div id="photoViewer" class="photo-viewer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:4000; align-items:center; justify-content:center;" onclick="this.style.display='none'"><img id="viewerImage" style="max-width:100%; max-height:100%; border-radius:8px;"></div>

<script>
class TravelApp {
    constructor() {
        this.trips = [];
        this.currentTripIndex = 0;
        this.expandedDays = new Set();
        this.editingEventId = null;
        this.filterStatus = 'all';
        this.geminiApiKey = localStorage.getItem('gemini_api_key') || "";
        this.init();
    }

    init() {
        this.loadTheme();
        this.loadData();
        this.render();
        this.startTimeClock();
    }

    startTimeClock() { this.updateTime(); setInterval(() => this.updateTime(), 1000); }
    updateTime() {
        const kstEl = document.getElementById('clockKST');
        const locEl = document.getElementById('clockLOC');
        if(!kstEl || !locEl) return;

        const now = new Date();
        const kstHour = now.getHours();
        this.updateClockStyle(kstEl, kstHour, 'ì„œìš¸ KST', now.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit', hour12:false}));
        const locTime = new Date(now.getTime() + (2*60*60*1000));
        this.updateClockStyle(locEl, locTime.getHours(), 'í˜„ì§€ AEDT', locTime.toLocaleTimeString('en-AU', {hour:'2-digit', minute:'2-digit', hour12:false}));
    }
    updateClockStyle(el, h, label, time) {
        const isDay = h >= 6 && h < 18;
        el.className = `clock-box ${isDay?'day':'night'}`;
        el.innerHTML = `<div class="clock-label">${label} ${isDay?'â˜€ï¸':'ğŸŒ™'}</div><div class="clock-time">${time}</div>`;
    }

    loadTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) document.documentElement.setAttribute('data-theme', savedTheme);
        this.updateThemeIcon();
    }
    toggleTheme() {
        const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        this.updateThemeIcon();
    }
    updateThemeIcon() {
        const el = document.getElementById('themeToggle');
        if(el) el.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    generateEventId() { return `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`; }
    
    // --- ë§›ì§‘ ê°€ì´ë“œ Drawer ---
    openDiningDrawer(date) {
        const trip = this.trips[this.currentTripIndex];
        const diningData = trip.dining[date];
        const content = document.getElementById('diningContent');
        const drawer = document.getElementById('diningDrawer');
        const overlay = document.querySelector('.drawer-overlay');
        
        let html = `<div style="text-align:center; margin-bottom:16px; font-weight:700; color:var(--text-secondary); font-size:14px;">${this.formatDate(date)} ì¶”ì²œ ë§›ì§‘</div>`;
        
        if (!diningData) {
            html += `<div class="empty-state"><p>ë§›ì§‘ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
        } else {
            const meals = { 'ğŸ³ ì¡°ì‹': diningData.breakfast, 'ğŸ ì¤‘ì‹': diningData.lunch, 'ğŸ· ì„ì‹': diningData.dinner };
            for (const [title, places] of Object.entries(meals)) {
                html += `<div class="dining-section"><div class="dining-section-title">${title}</div>`;
                if (places && places.length > 0) {
                    places.forEach(p => {
                        const reasonHtml = p.reason ? `<div class="res-row"><div class="res-icon">ğŸ’¡</div><div class="res-text"><span class="res-label">Why?</span>${p.reason}</div></div>` : '';
                        const menuHtml = p.menu ? `<div class="res-row"><div class="res-icon">ğŸ½ï¸</div><div class="res-text"><span class="res-label">Menu</span>${p.menu}</div></div>` : '';
                        
                        html += `
                        <div class="restaurant-item">
                            <div class="res-name">${p.name}</div>
                            <div class="res-desc">${p.desc}</div>
                            ${(reasonHtml || menuHtml) ? `<div class="res-details">${reasonHtml}${menuHtml}</div>` : ''}
                            <div class="res-action">
                                <a href="https://maps.google.com/?q=${encodeURIComponent(p.name + ' ' + trip.destination)}" target="_blank" class="btn-map-sm">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</a>
                            </div>
                        </div>`;
                    });
                } else { html += `<p style="font-size:12px; color:var(--text-secondary); font-style:italic; padding:8px;">ì´ë™ ì¤‘ì´ê±°ë‚˜ ììœ  ì‹ì‚¬</p>`; }
                html += `</div>`;
            }
        }
        content.innerHTML = html;
        drawer.classList.add('open');
        overlay.classList.add('show');
    }
    closeDiningDrawer() {
        document.getElementById('diningDrawer').classList.remove('open');
        document.querySelector('.drawer-overlay').classList.remove('show');
    }

    loadData() {
        try {
            // FORCE NEW DATA LOAD (Version bump + Key change to avoid caching issues)
            const saved = localStorage.getItem('travel_data_final_fix_v4');
            if (saved) {
                this.trips = JSON.parse(saved);
            } else {
                this.trips = [{
                    name: 'í˜¸ì£¼ ê°€ì¡± ì—¬í–‰', destination: 'ë©œë²„ë¥¸ & ì‹œë“œë‹ˆ', startDate: '2025-12-22', endDate: '2025-12-29',
                    dining: {
                        "2025-12-22": { dinner: [{name:"Gami Chicken & Beer",desc:"ì¹˜ë§¥", reason:"ì•¼ì‹ìœ¼ë¡œ ìµœê³ ", menu:"Boneless Chicken"},{name:"Grill'd",desc:"ìˆ˜ì œë²„ê±°", reason:"ê±´ê°•í•œ ë§›", menu:"Simply Cheese"}]},
                        "2025-12-23": { breakfast:[{name:"Hardware SociÃ©tÃ©",desc:"ë¸ŒëŸ°ì¹˜", reason:"ëìŠ¤í„° ë² ë„¤ë”•íŠ¸ ìœ ëª…", menu:"Lobster Benedict"}], lunch:[{name:"Puffing Billy Cafe",desc:"ê°„ë‹¨ì‹", reason:"ì´ë™ ì¤‘ ì‹ì‚¬", menu:"Meat Pie"}], dinner:[{name:"Pino's Trattoria",desc:"ì´íƒˆë¦¬ì•ˆ", reason:"ê°€ì¡± ì‹ì‚¬ ì í•©", menu:"Pizza"}]},
                        "2025-12-24": { breakfast:[{name:"Grain Store",desc:"ë¸ŒëŸ°ì¹˜", reason:"ìœ ê¸°ë† ì¬ë£Œ", menu:"Pancakes"}], lunch:[{name:"Movida Next Door",desc:"íƒ€íŒŒìŠ¤", reason:"ë¯¸ì‚¬ê±°ë¦¬ ì˜†", menu:"Croqueta"}], dinner:[{name:"La Camera Southgate",desc:"ì´íƒˆë¦¬ì•ˆ", reason:"ì•¼ë¼ê°• ë·°", menu:"Risotto"}]},
                        "2025-12-25": { breakfast:[{name:"Hotel Indigo ì¡°ì‹",desc:"í˜¸í…” ì‹ì‚¬", reason:"í¬ë¦¬ìŠ¤ë§ˆìŠ¤ë¼ ì•ˆì „", menu:"Buffet"}], lunch:[{name:"ë©œë²„ë¥¸ ê³µí•­ ì‹ë‹¹",desc:"ê°„ë‹¨ì‹", reason:"ì´ë™ ì¤‘", menu:"Burger"}], dinner:[{name:"Nick's Seafood",desc:"ì”¨í‘¸ë“œ", reason:"ë‹¬ë§í•˜ë²„ ë·°", menu:"Seafood Platter"}]},
                        "2025-12-26": { breakfast:[{name:"The Grounds",desc:"ì¹´í˜", reason:"ì‚¬ì§„ ë§›ì§‘", menu:"Coffee"}], lunch:[{name:"Loaves & Dishes",desc:"ë¸ŒëŸ°ì¹˜", reason:"ë¡œë¼ ë§ˆì„", menu:"Soup"}], dinner:[{name:"Mamak",desc:"ë§ë ˆì´ì‹œì•„", reason:"ë¡œí‹° ë§›ì§‘", menu:"Roti"}]},
                        "2025-12-27": { breakfast:[{name:"Bills",desc:"ë¸ŒëŸ°ì¹˜", reason:"í•«ì¼€ì´í¬ ì›ì¡°", menu:"Ricotta Hotcakes"}], lunch:[{name:"The Little Nel",desc:"ì¹´í˜", reason:"ë„¬ìŠ¨ë² ì´", menu:"Acai Bowl"}], dinner:[{name:"Din Tai Fung",desc:"ë”¤ì„¬", reason:"í˜¸ë¶ˆí˜¸ ì—†ìŒ", menu:"Xiao Long Bao"}]},
                        "2025-12-28": { breakfast:[{name:"Social Brew",desc:"ì¹´í˜", reason:"ë¡œì»¬ ë¶„ìœ„ê¸°", menu:"Brekkie Roll"}], lunch:[{name:"Opera Bar",desc:"ì–‘ì‹", reason:"ì˜¤í˜ë¼í•˜ìš°ìŠ¤ ë·°", menu:"Pizza"}], dinner:[{name:"Pancakes on The Rocks",desc:"ì–‘ì‹", reason:"24ì‹œê°„ ìš´ì˜", menu:"Pancakes"}]},
                        "2025-12-29": { breakfast:[{name:"Campos Coffee",desc:"ì¹´í˜", reason:"ì‹œë“œë‹ˆ 3ëŒ€ ì»¤í”¼", menu:"Affogato"}], lunch:[{name:"ê¸°ë‚´ì‹",desc:"í•œì‹", reason:"", menu:"Bibimbap"}]}
                    },
                    events: [
                        { id: 'e1', date: '2025-12-22', time: '08:00', endTime: '20:30', category: 'í•­ê³µ', title: 'ì¸ì²œ(ICN) âœˆï¸ ë©œë²„ë¥¸(MEL)', description: 'ì•„ì‹œì•„ë‚˜ OZ601í¸\n08:00 ì¶œë°œ', location: 'Melbourne Airport', mapLink: 'https://maps.google.com/?cid=12188597685268332047', completed: false, photos: [] },
                        { id: 'e2', date: '2025-12-22', time: '20:30', endTime: '23:00', category: 'ê¸°íƒ€', title: 'í˜¸í…” ì´ë™ (Indigo)', description: 'ìŠ¤ì¹´ì´ë²„ìŠ¤ ì´ìš©\nIndigo í˜¸í…” ì²´í¬ì¸', location: 'Hotel Indigo Melbourne on Flinders', mapLink: 'https://maps.app.goo.gl/11zV22p4W65DwKkE7', completed: false, photos: [] },
                        { id: 'e3', date: '2025-12-23', time: '09:30', endTime: '22:00', category: 'íˆ¬ì–´', title: 'í¼í•‘ë¹Œë¦¬ & í­ê·„', description: 'ì¼ì¼ íˆ¬ì–´ íŒ¨í‚¤ì§€', location: 'Meeting Point', mapLink: '', completed: false },
                        { id: 'e5', date: '2025-12-24', time: '10:30', endTime: '12:30', category: 'ê´€ê´‘', title: 'í”Œë¦°ë”ìŠ¤ ì—­ & í˜¸ì‹œì–´ ë ˆì¸', description: 'ì‹œí‹° íˆ¬ì–´', location: 'Flinders St Station', mapLink: '', completed: false },
                        { id: 'e7', date: '2025-12-24', time: '14:30', endTime: '16:00', category: 'ê´€ê´‘', title: 'í€¸ ë¹…í† ë¦¬ì•„ ë§ˆì¼“', description: 'ì‡¼í•‘', location: 'Queen Victoria Market', mapLink: '', completed: false },
                        { id: 'e9', date: '2025-12-25', time: '15:00', endTime: '16:30', category: 'í•­ê³µ', title: 'ë©œë²„ë¥¸(MEL) âœˆï¸ ì‹œë“œë‹ˆ(SYD)', description: 'êµ­ë‚´ì„  ì´ë™', location: 'Sydney Airport (SYD)', mapLink: '', completed: false },
                        { id: 'e10', date: '2025-12-25', time: '17:00', endTime: '17:30', category: 'ê¸°íƒ€', title: 'í˜¸í…” ì´ë™ (Meriton)', description: 'Meriton Suites ì´ë™', location: 'Meriton Suites Kent Street', mapLink: '', completed: false },
                        { id: 'e11', date: '2025-12-25', time: '19:30', category: 'ì €ë…', title: 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë””ë„ˆ', description: 'Nick\'s Seafood (ì˜ˆì•½í•„ìˆ˜)', location: 'Darling Harbour', mapLink: '', completed: false },
                        { id: 'e12', date: '2025-12-26', time: '07:30', endTime: '18:30', category: 'íˆ¬ì–´', title: 'ë¸”ë£¨ë§ˆìš´í‹´', description: 'ì¼ì¼ íˆ¬ì–´', location: 'Meeting Point', mapLink: '', completed: false },
                        { id: 'e13', date: '2025-12-27', time: '07:30', endTime: '19:00', category: 'íˆ¬ì–´', title: 'í¬íŠ¸ìŠ¤í…ŒíŒ', description: 'ì‚¬ë§‰ ìƒŒë“œë³´ë”©', location: 'Meeting Point', mapLink: '', completed: false },
                        { id: 'e14', date: '2025-12-28', time: '10:30', category: 'ê´€ê´‘', title: 'ì˜¤í˜ë¼ í•˜ìš°ìŠ¤', description: 'ì‹œí‹° íˆ¬ì–´', location: 'Circular Quay', mapLink: '', completed: false },
                        { id: 'e16', date: '2025-12-28', time: '14:00', category: 'ê´€ê´‘', title: 'ë³¸ë‹¤ì´ ë¹„ì¹˜', description: 'í•´ë³€ ì‚°ì±…', location: 'Bondi Beach', mapLink: '', completed: false },
                        { id: 'e18', date: '2025-12-29', time: '10:20', endTime: '19:00', category: 'í•­ê³µ', title: 'ì‹œë“œë‹ˆ(SYD) âœˆï¸ ì¸ì²œ(ICN)', description: 'ì•„ì‹œì•„ë‚˜ OZ602í¸\n10:20 ì¶œë°œ', location: 'Sydney International Airport', mapLink: 'https://www.google.com/maps/dir/Meriton+Suites+Kent+Street,+Sydney/Sydney+Airport', completed: false }
                    ]
                }];
                this.trips.forEach(t => t.events.forEach(e => { if(!e.id) e.id = this.generateEventId(); }));
                this.saveData();
            }
        } catch(e) {
            console.error("Data load failed", e);
            localStorage.clear();
            location.reload();
        }
    }
    saveData() { localStorage.setItem('travel_data_final_fix_v4', JSON.stringify(this.trips)); }

    getFilteredTrips() { return this.filterStatus==='all'?this.trips:this.trips.filter(t=>this.getTripStatus(t)===this.filterStatus); }
    getTripStatus(t) { const today=new Date(); today.setHours(0,0,0,0); const s=new Date(t.startDate); const e=new Date(t.endDate); return today<s?'upcoming':today>e?'completed':'ongoing'; }
    getDDay(d) { const diff=Math.ceil((new Date(d)-new Date().setHours(0,0,0,0))/(1000*60*60*24)); return diff>0?`D-${diff}`:diff===0?'D-Day':'ì—¬í–‰ì¤‘'; }
    formatDate(d) { return `${new Date(d).getMonth()+1}ì›” ${new Date(d).getDate()}ì¼`; }
    
    toggleDay(d) { document.getElementById(`day-${d}`).classList.toggle('expanded'); }
    toggleComplete(id) { const t=this.trips[this.currentTripIndex]; const e=t.events.find(x=>x.id===id); if(e){e.completed=!e.completed; this.saveData(); this.render();} }

    // --- Modal Logic (Fixed) ---
    openModal(id) {
        const c = document.getElementById('modal-container');
        if(id==='aiModal') c.innerHTML = `<div id="aiModal" class="modal show"><div class="modal-content"><h3>ğŸ¤– AI ë¹„ì„œ</h3><div class="chat-container"><div id="chatBox" class="chat-messages"></div><div style="display:flex;gap:8px"><input id="chatInput" class="form-input" style="margin:0"><button class="btn btn-add-event" onclick="app.handleChat()">ì „ì†¡</button></div></div><div class="modal-actions"><button class="btn" onclick="app.closeModal('aiModal')">ë‹«ê¸°</button></div></div></div>`;
        else if(id==='addEventModal') c.innerHTML = `<div id="addEventModal" class="modal show"><div class="modal-content"><h3>â• ì¼ì • ì¶”ê°€</h3><input id="newEventTitle" class="form-input" placeholder="ì œëª©"><textarea id="newEventDescription" class="form-textarea" placeholder="ì„¤ëª…"></textarea><button class="btn" style="width:100%;margin-bottom:10px;border:1px solid #ccc" onclick="app.autoFillEventDesc()">âœ¨ ìë™ì™„ì„±</button><div class="modal-actions"><button class="btn btn-success" onclick="app.addEvent()">ì¶”ê°€</button><button class="btn btn-danger" onclick="app.closeModal('addEventModal')">ì·¨ì†Œ</button></div></div></div>`;
        else if(id==='editEventModal') {
            const event = this.trips[this.currentTripIndex].events.find(e => e.id === this.editingEventId);
            if(event) {
                const cats = ['ê´€ê´‘','í•­ê³µ','ì¡°ì‹','ì ì‹¬','ì €ë…','íˆ¬ì–´','ì‡¼í•‘','ê¸°íƒ€'];
                c.innerHTML = `<div id="editEventModal" class="modal show"><div class="modal-content"><h3>âœï¸ ì¼ì • ìˆ˜ì •</h3>
                    <div class="form-group"><label class="form-label">ë‚ ì§œ</label><input type="date" id="editEventDate" class="form-input" value="${event.date}"></div>
                    <div class="form-group"><label class="form-label">ì‹œê°„</label><div style="display:flex;gap:8px"><input type="time" id="editEventTime" class="form-input" value="${event.time}"><input type="time" id="editEventEndTime" class="form-input" value="${event.endTime||''}"></div></div>
                    <div class="form-group"><label class="form-label">ì¹´í…Œê³ ë¦¬</label><select id="editEventCategory" class="form-select">${cats.map(cat => `<option value="${cat}" ${event.category === cat ? 'selected' : ''}>${cat}</option>`).join('')}</select></div>
                    <div class="form-group"><label class="form-label">ì œëª©</label><input id="editEventTitle" class="form-input" value="${event.title}"></div>
                    <div class="form-group"><label class="form-label">ì¥ì†Œ</label><input id="editEventLocation" class="form-input" value="${event.location}"></div>
                    <div class="form-group"><label class="form-label">ì§€ë„ ë§í¬</label><input id="editEventMapLink" class="form-input" value="${event.mapLink || ''}" placeholder="https://maps.google.com/..."></div>
                    <div class="form-group"><label class="form-label">ì„¤ëª…</label><textarea id="editEventDescription" class="form-textarea">${event.description}</textarea></div>
                    <div class="modal-actions"><button class="btn btn-primary" onclick="app.updateEvent()">ì €ì¥</button><button class="btn btn-danger" onclick="app.closeModal('editEventModal')">ì·¨ì†Œ</button></div></div></div>`;
            }
        }
        else if(id === 'addTripModal') {
            c.innerHTML = `<div id="addTripModal" class="modal show"><div class="modal-content"><h3>ğŸ†• ìƒˆ ì—¬í–‰</h3><div class="form-group"><label class="form-label">ì—¬í–‰ ì´ë¦„</label><input id="newTripName" class="form-input"></div><div class="modal-actions"><button class="btn btn-success" onclick="app.addTrip()">ì¶”ê°€</button><button class="btn btn-danger" onclick="app.closeModal('addTripModal')">ì·¨ì†Œ</button></div></div></div>`;
        }
        else if(id === 'editTripModal') {
             const t = this.trips[this.currentTripIndex];
             c.innerHTML = `<div id="editTripModal" class="modal show"><div class="modal-content"><h3>âœï¸ ì—¬í–‰ ìˆ˜ì •</h3><div class="form-group"><label class="form-label">ì´ë¦„</label><input id="editTripName" class="form-input" value="${t.name}"></div><div class="form-group"><label class="form-label">ì¥ì†Œ</label><input id="editTripDestination" class="form-input" value="${t.destination}"></div><div class="form-group"><label class="form-label">ì‹œì‘ì¼</label><input type="date" id="editTripStartDate" class="form-input" value="${t.startDate}"></div><div class="form-group"><label class="form-label">ì¢…ë£Œì¼</label><input type="date" id="editTripEndDate" class="form-input" value="${t.endDate}"></div><div class="modal-actions"><button class="btn btn-primary" onclick="app.updateTrip()">ì €ì¥</button><button class="btn btn-danger" onclick="app.closeModal('editTripModal')">ì·¨ì†Œ</button></div></div></div>`;
        }
        else if(id === 'settingsModal') {
            c.innerHTML = `<div id="settingsModal" class="modal show"><div class="modal-content"><h3>âš™ï¸ ì„¤ì •</h3><div class="form-group"><label class="form-label">Gemini API Key</label><input id="apiKeyInput" class="form-input" type="password" value="${this.geminiApiKey}" placeholder="API Key ì…ë ¥"></div><div class="modal-actions"><button class="btn btn-primary" onclick="app.saveApiKey()">ì €ì¥</button><button class="btn btn-danger" onclick="app.closeModal('settingsModal')">ë‹«ê¸°</button></div></div></div>`;
        }
        else if(id === 'reviewModal') {
            c.innerHTML = `<div id="reviewModal" class="modal show"><div class="modal-content"><h3>ğŸ“ í›„ê¸°</h3><div class="form-group"><textarea id="tripReview" class="form-textarea" placeholder="ì—¬í–‰ í›„ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”">${this.trips[this.currentTripIndex].review || ''}</textarea></div><div class="modal-actions"><button class="btn btn-primary" onclick="app.updateReview()">ì €ì¥</button><button class="btn btn-danger" onclick="app.closeModal('reviewModal')">ì·¨ì†Œ</button></div></div></div>`;
        }
    }
    closeModal(id) { document.getElementById('modal-container').innerHTML=''; }
    
    // --- AI ---
    async handleChat() {
        const i=document.getElementById('chatInput'); const m=i.value.trim(); if(!m)return;
        this.addChatMsg('user',m); i.value=''; this.addChatMsg('ai','...',true);
        if(!this.geminiApiKey){ this.addChatMsg('ai','API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
        try {
            const r=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.geminiApiKey}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{parts:[{text:`í˜¸ì£¼ ì—¬í–‰ ì§ˆë¬¸: ${m}`}]}]})});
            const d=await r.json(); this.addChatMsg('ai',d.candidates?.[0]?.content?.parts?.[0]?.text||"ì˜¤ë¥˜");
        } catch(e){this.addChatMsg('ai','í†µì‹  ì˜¤ë¥˜');}
    }
    addChatMsg(r,t,l=false) { const b=document.getElementById('chatBox'); b.innerHTML+=`<div class="chat-msg ${r}">${l?`<span class="loading-dots">...</span>`:t}</div>`; b.scrollTop=b.scrollHeight; }
    async autoFillEventDesc() { alert('AI í‚¤ ì„¤ì • í•„ìš”'); }

    // --- Actions ---
    addEvent() { const t=document.getElementById('newEventTitle').value; if(!t)return; const tr=this.trips[this.currentTripIndex]; tr.events.push({id:this.generateEventId(), title:t, description:document.getElementById('newEventDescription').value, date:tr.startDate, time:'09:00', category:'ê´€ê´‘', completed:false, photos:[]}); this.saveData(); this.closeModal('addEventModal'); this.render(); }
    updateEvent() { 
        const t=this.trips[this.currentTripIndex]; 
        const e=t.events.find(x=>x.id===this.editingEventId); 
        if(e){ 
            e.date = document.getElementById('editEventDate').value;
            e.time = document.getElementById('editEventTime').value;
            e.endTime = document.getElementById('editEventEndTime').value;
            e.category = document.getElementById('editEventCategory').value;
            e.title=document.getElementById('editEventTitle').value; 
            e.location=document.getElementById('editEventLocation').value; 
            e.description=document.getElementById('editEventDescription').value;
            e.mapLink=document.getElementById('editEventMapLink').value;
            t.events.sort((a, b) => (a.date+a.time).localeCompare(b.date+b.time));
            this.saveData(); this.closeModal('editEventModal'); this.render(); 
        } 
    }
    deleteEvent(id) { if(confirm('ì‚­ì œ?')){ const t=this.trips[this.currentTripIndex]; t.events=t.events.filter(e=>e.id!==id); this.saveData(); this.render(); } }
    addPhoto(id) { alert('ì‚¬ì§„ ì¶”ê°€'); }
    addTrip() { const n=document.getElementById('newTripName').value; if(n){ this.trips.push({name:n,destination:'',startDate:new Date().toISOString().split('T')[0],endDate:new Date().toISOString().split('T')[0],events:[],dining:{}}); this.currentTripIndex=this.trips.length-1; this.saveData(); this.closeModal('addTripModal'); this.render(); } }
    updateTrip() {
        const t = this.trips[this.currentTripIndex];
        t.name = document.getElementById('editTripName').value;
        t.destination = document.getElementById('editTripDestination').value;
        t.startDate = document.getElementById('editTripStartDate').value;
        t.endDate = document.getElementById('editTripEndDate').value;
        this.saveData(); this.closeModal('editTripModal'); this.render();
    }
    updateReview() {
        const t = this.trips[this.currentTripIndex];
        t.review = document.getElementById('tripReview').value;
        this.saveData(); this.closeModal('reviewModal');
    }
    exportData() { alert('ë°±ì—…'); }
    importData() { alert('ë³µì›'); }
    exportToCalendar() { alert('ìº˜ë¦°ë”'); }
    changeFilter(s) { this.filterStatus=s; this.render(); }

    // --- Dining Drawer ---
    openDiningDrawer(date) {
        const trip = this.trips[this.currentTripIndex];
        const d = trip.dining ? trip.dining[date] : null;
        const content = document.getElementById('diningContent');
        const drawer = document.getElementById('diningDrawer');
        const overlay = document.querySelector('.drawer-overlay');
        let h = `<div style="text-align:center;margin-bottom:15px;font-weight:700">${this.formatDate(date)}</div>`;
        if(!d) h+=`<div class="empty-state">ì •ë³´ ì—†ìŒ</div>`;
        else {
            const m = {'ğŸ³ ì¡°ì‹':d.breakfast, 'ğŸ ì¤‘ì‹':d.lunch, 'ğŸ· ì„ì‹':d.dinner};
            for(const [k,v] of Object.entries(m)) {
                h+=`<div class="dining-section"><div class="dining-section-title">${k}</div>`;
                if(v && v.length) v.forEach(p=>{
                    h+=`<div class="restaurant-item"><div class="res-name">${p.name}</div><div class="res-desc">${p.desc}</div>
                    ${p.reason ? `<div class="res-details"><div class="res-row"><div class="res-icon">ğŸ’¡</div><div class="res-text"><span class="res-label">Why?</span>${p.reason}</div></div><div class="res-row"><div class="res-icon">ğŸ½ï¸</div><div class="res-text"><span class="res-label">Menu</span>${p.menu}</div></div></div>` : ''}
                    <div class="res-action"><a href="https://maps.google.com/?q=${encodeURIComponent(p.name+' '+trip.destination)}" target="_blank" class="btn-map-sm">ğŸ—ºï¸ ì§€ë„ ë³´ê¸°</a></div></div>`;
                });
                else h+=`<p style="font-size:12px;color:#64748b">ì¼ì • ì—†ìŒ</p>`;
                h+=`</div>`;
            }
        }
        content.innerHTML=h;
        drawer.classList.add('open'); overlay.classList.add('show');
    }
    closeDiningDrawer() { document.getElementById('diningDrawer').classList.remove('open'); document.querySelector('.drawer-overlay').classList.remove('show'); }
    
    showModal(id, arg) { this.editingEventId=arg; this.openModal(id); }

    render() {
        const t = this.getFilteredTrips()[this.currentTripIndex];
        const app = document.getElementById('app');
        if(!t) { app.innerHTML = 'No Trip'; return; }
        const grouped = {};
        t.events.forEach(e => { if(!grouped[e.date]) grouped[e.date]=[]; grouped[e.date].push(e); });
        
        let html = `
            <div class="header">
                <div class="header-content">
                    <div class="header-top">
                        <div class="trip-info"><h1>${t.name}</h1>
                            <div class="trip-meta-row">
                                <div class="trip-details"><span>ğŸ“ ${t.destination}</span><span>ğŸ—“ï¸ ${t.startDate} ~ ${t.endDate}</span></div>
                                <div class="clock-container"><div id="clockKST" class="clock-box"></div><div id="clockLOC" class="clock-box"></div></div>
                            </div>
                        </div>
                        <div class="dday-badge">${this.getDDay(t.startDate)}</div>
                    </div>
                    
                    <div class="trip-tabs">
                        <div class="trip-tab ${this.filterStatus==='all'?'active':''}" onclick="app.changeFilter('all')">ğŸ“š ì „ì²´</div>
                        <div class="trip-tab ${this.filterStatus==='upcoming'?'active':''}" onclick="app.changeFilter('upcoming')">ğŸ—“ï¸ ì˜ˆì •</div>
                        <div class="trip-tab ${this.filterStatus==='ongoing'?'active':''}" onclick="app.changeFilter('ongoing')">âœˆï¸ ì§„í–‰ì¤‘</div>
                        <div class="trip-tab ${this.filterStatus==='completed'?'active':''}" onclick="app.changeFilter('completed')">âœ… ì™„ë£Œ</div>
                    </div>
                    <div class="action-buttons">
                        <!-- ë§ˆì´ë¦¬ì–¼íŠ¸ë¦½ ë¡œê³  ë²„íŠ¼ (í…ìŠ¤íŠ¸ ë²„ì „) -->
                        <button class="btn btn-mrt" onclick="window.open('https://www.myrealtrip.com','_blank')">
                            <span class="mrt-logo"><span class="mrt-my">My</span><span class="mrt-trip">realtrip</span></span>
                        </button>
                        <button class="btn btn-ai" onclick="app.openModal('aiModal')">âœ¨ AI ë¹„ì„œ</button>
                        <!-- ì¼ì • ì¶”ê°€ (ê°•ì¡° ìŠ¤íƒ€ì¼) -->
                        <button class="btn btn-add-event" onclick="app.openModal('addEventModal')">â• ì¼ì • ì¶”ê°€</button>
                        <button class="btn" onclick="app.showModal('editTripModal')">âœï¸ ìˆ˜ì •</button>
                        <button class="btn" onclick="app.openModal('reviewModal')">ğŸ“ í›„ê¸°</button>
                        <button class="btn" onclick="app.exportToCalendar()">ğŸ“… ìº˜ë¦°ë”</button>
                        <button class="btn" onclick="app.exportData()">ğŸ’¾ ë°±ì—…</button>
                        <label class="btn">ğŸ“‚ ë³µì›<input type="file" hidden onchange="app.importData(this.files[0])"></label>
                        <button class="btn" onclick="app.openModal('settingsModal')">âš™ï¸ ì„¤ì •</button>
                        <button class="btn" style="color:var(--danger);border-color:var(--danger)" onclick="app.deleteTrip()">ğŸ—‘ï¸ ì‚­ì œ</button>
                    </div>
                </div>
            </div>
            <div class="container">`;

        Object.keys(grouped).sort().forEach(date => {
            const isExp = new Date(date) >= new Date().setHours(0,0,0,0) ? 'expanded' : '';
            html += `<div class="day-card ${isExp}" id="day-${date}">
                <div class="day-header" onclick="app.toggleDay('${date}')">
                    <div class="day-info-wrapper"><div class="day-number">${new Date(date).getDate()}</div><div class="day-text"><h3>${new Date(date).getMonth()+1}ì›” ${new Date(date).getDate()}ì¼</h3><span>ì¼ì • ${grouped[date].length}ê°œ</span></div></div>
                    <div class="day-controls"><button class="btn-dining-mini" onclick="event.stopPropagation(); app.openDiningDrawer('${date}')">ğŸ½ï¸ ë§›ì§‘</button><div class="day-arrow">â–¼</div></div>
                </div>
                <div class="event-list">${grouped[date].map(e => this.renderEvent(e)).join('')}</div>
            </div>`;
        });
        html += `</div>`;
        app.innerHTML = html;
    }

    renderEvent(e) {
        const btns = `<div class="event-actions"><a href="${e.mapLink||'#'}" target="_blank" class="btn-sm">ğŸ—ºï¸ ì§€ë„</a><button class="btn-sm" onclick="app.addPhoto('${e.id}')">ğŸ“¸ ì‚¬ì§„</button><button class="btn-sm" onclick="app.showModal('editEventModal','${e.id}')">âœï¸ ìˆ˜ì •</button><button class="btn-sm" style="color:red" onclick="app.deleteEvent('${e.id}')">ğŸ—‘ï¸ ì‚­ì œ</button></div>`;
        if(e.category === 'í•­ê³µ') {
            return `<div class="flight-card"><div class="flight-header"><span>FLIGHT</span><span>${e.time}-${e.endTime}</span></div><div class="flight-route"><span class="port-code">DEP</span><span class="flight-icon">âœˆï¸</span><span class="port-code">ARR</span></div><div class="flight-info">${e.description.replace(/\n/g,'<br>')}</div>${btns}</div>`;
        }
        return `<div class="event-item"><div class="event-header"><span class="category-badge category-${e.category}">${e.category}</span><span class="event-time">${e.time}</span></div><div class="event-title">${e.title}</div><div class="event-desc">${e.description}</div>${btns}</div>`;
    }
}
const app = new TravelApp();
</script>
</body>
</html>
